# jamddo - 재미로 해보는 로또 시뮬레이션
<img src="./docs/thumb.png">


## :date: 프로젝트 진행 기간
2022.11.21 ~ 2023.01.31

## ✔ 서비스 소개
로또 시뮬레이션을 진행해볼 수 있는 웹사이트 입니다.

## ✔ 사용 기술
Frontend
- Vue

Backend
- SpringBoot, JPA, Querydsl

Database
- MySQL

Infra
- Docker, EC2

## ✔ 기능 소개
### 시뮬레이션 기능
- 하나 구매하기
    - 1부터 45 사이 6개의 숫자를 임의로 생성한 뒤 로또 당첨번호와 비교해 점수를 계산합니다.
    - 로그인 상태라면 구매 시 1000point가 감소, 당첨 시 당첨 금액만큼 point가 증가합니다.
    - 로그인 하지 않은 상태라면 point 변화 없이 구매 기능을 이용할 수 있습니다.        
- N개 구매하기
    - N번의 구매를 실행합니다. N회 실행 결과를 당첨 순위가 높은 값부터 내림차순으로 반환합니다.
    - point에 영향을 주지 않습니다.        
- 1등이 될 때까지 구매하기
    - 1등이 당첨될 때까지 구매를 진행합니다. 1등이 당첨되기까지 소모된 돈, 다른 당첨내역 등의 정보를 반환합니다.
    - point에 영향을 주지 않습니다.
### 통계정보 제공 기능
- 페이지 접근 시 1등 정보와 통계정보를 반환해 줍니다. 이번주 당첨번호, 이번주 상금 정보, 역대 당첨번호 통계 정보를 제공합니다.
### 로그인 기능
- SpringSecurity와 JWT로 회원가입 및 로그인 기능을 구현했습니다.

## ✔ 고민한 내용
- DB와의 통신을 최소화하는 구조에 대해 고민했습니다. 초창기 로또를 구매할 때마다 로또번호를 생성하고 DB에서 이번 회차 당첨번호를 받아와 등수를 확인행했었습니다. 이를 개선하기 위해 로또를 구매하는 buy와 점수를 계산하는 scoring을 분리하고 DB에서 당첨번호를 생성자 호출 시점에 전역변수로 선언해 DB에 접근하는 횟수를 줄였습니다.
- 프로젝트의 규모와 구현 가능성에 대해 고민했습니다. 백엔드 서버를 구현하는 게 프로젝트의 주 목적이었기 때문에 현재 실력으로 구현할 수 없는 프론트엔드 기능을 많은 시간을 투자하면서 구현하는건 적합하지 않다고 생각했습니다. 프로젝트를 진행하면서 볼륨이 커져서 시스템이 완성되지 못하는 상황을 가장 경계했기 때문에 쉽고 구현 가능한 기술 위주로 작업을 진행했습니다.

## ✔ 문제 상황과 해결 과정
- Hikari CP의 커넥션 누수(Connection Leak) 현상을 겪었었습니다. 프론트엔드에서 페이지 created시점에 axios로 여러 통계 정보를 요청했을 때 간헐적으로 요청이 실패하는 문제가 발생했었습니다. leak-detection-threshold속성을 통해 검사를 진행하자 커넥션 누수가 발견되었다는 에러 메시지를 발견할 수 있었고 여러 실험을 통해 Querydsl 코드에 문제가 있음을 발견했습니다. Querydsl의 대상 엔티티가 아닌 연관관계가 설정된 다른 엔티티의 QType을 Projections.constructor에 곧바로 실행할 경우 QType엔티티가 제대로 로드되지 않는 문제를 발견했고, 대상 엔티티를 활용하는 방식으로 코드를 수정해 문제를 해결할 수 있었습니다. 
(자세한 설명은 [제 블로그](https://velog.io/@qwerty1434/querydsl%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%98%EB%A9%B4%EC%84%9C-%EA%B2%AA%EC%9D%80-hikari-leap%EC%97%90-%EB%8C%80%ED%95%B4)에 정리되어 있습니다.)
